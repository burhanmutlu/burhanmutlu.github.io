<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personel Takip</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <label for="monthSelect">Ay Seçin:</label>
    <select id="monthSelect" onchange="generateCalendar()">
        <option value="1">Ocak</option>
        <option value="2">Şubat</option>
        <option value="3">Mart</option>
        <option value="4">Nisan</option>
        <option value="5">Mayıs</option>
        <option value="6">Haziran</option>
        <option value="7">Temmuz</option>
        <option value="8">Ağustos</option>
        <option value="9">Eylül</option>
        <option value="10">Ekim</option>
        <option value="11">Kasım</option>
        <option value="12">Aralık</option>
    </select>

    <div class="container">
        <table id="personelTable">
            <thead>
                <tr>
                    <th class="fixed-column">T.C. Kimlik No</th>
                    <th class="fixed-column">Adı</th>
                    <th class="fixed-column">Soyadı</th>
                    <th class="fixed-column">Unvan</th>
                    <th class="fixed-column">Toplam Çalışma</th>
                    <th class="fixed-column">Norm. Çalışma</th>
                    <th class="fixed-column">Fazla Mesai</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" class="tcNo" onblur="validateTC(this)"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td>
                        <select>
                            <option value="Tıbbi Sekreter">Tıbbi Sekreter</option>
                            <option value="Hemşire">Hemşire</option>
                            <option value="Doktor">Doktor</option>
                            <option value="Ebe">Ebe</option>
                        </select>
                    </td>
                    <td class="total-work-cell">0</td>
                    <td class="normal-hours-cell">0</td>
                    <td class="overtime-cell">0</td>
                </tr>
            </tbody>
        </table>
    </div>
    <button onclick="addRow()">Ekle</button>
    <button onclick="generateOvertimeReport()" class="primary-button">Fazla Mesai Raporu Hazırla</button>
    
    <div style="margin-top: 20px;">
        <a href="holidays.html" class="nav-link">Resmi Tatil Yönetimi</a>
    </div>
    
    <div style="margin-top: 20px; max-width: 800px;" id="leaveTypeInfo">
        <h3>İzin Türleri</h3>
        <table class="info-table">
            <thead>
                <tr>
                    <th>İzin Türü</th>
                    <th>Kısa Kod</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>EVLİLİK İZNİ, EĞİTİM İZNİ</td><td>EV - Eİ</td></tr>
                <tr><td>YILLIK İZİN</td><td>Yİ</td></tr>
                <tr><td>GÖREVLENDİRME</td><td>GÖ</td></tr>
                <tr><td>RAPORLU</td><td>R</td></tr>
                <tr><td>MAZERET İZNİ</td><td>Mİ</td></tr>
                <tr><td>ÖLÜM İZNİ</td><td>Öİ</td></tr>
                <tr><td>REFAKAT İZNİ</td><td>Rİ</td></tr>
                <tr><td>SENDİKA İZNİ</td><td>SEİ</td></tr>
                <tr><td>ÜCRETSİZ İZİN</td><td>Üİ</td></tr>
                <tr><td>KONGRE İZNİ</td><td>Kİ</td></tr>
                <tr><td>İŞ KAZASI</td><td>İK</td></tr>
                <tr><td>DOĞUM SONU İZNİ</td><td>DSİ</td></tr>
                <tr><td>DOĞUM ÖNCESİ İZNİ</td><td>DÖİ</td></tr>
                <tr><td>NÖBET İZNİ</td><td>Nİ</td></tr>
                <tr><td>İDARİ İZİN</td><td>İDİ</td></tr>
                <tr><td>HASTANEYE YATIŞ</td><td>HY</td></tr>
                <tr><td>HAFTA SONU</td><td>HS</td></tr>
                <tr><td>RESMİ TATİL</td><td>RT</td></tr>
            </tbody>
        </table>
    </div>
    
    <!-- İzin tipi seçme kutusu (gizli) -->
    <div class="leave-select" id="leaveTypeSelect">
        <div data-code="EV-Eİ">EVLİLİK İZNİ, EĞİTİM İZNİ (EV-Eİ)</div>
        <div data-code="Yİ">YILLIK İZİN (Yİ)</div>
        <div data-code="GÖ">GÖREVLENDİRME (GÖ)</div>
        <div data-code="R">RAPORLU (R)</div>
        <div data-code="Mİ">MAZERET İZNİ (Mİ)</div>
        <div data-code="Öİ">ÖLÜM İZNİ (Öİ)</div>
        <div data-code="Rİ">REFAKAT İZNİ (Rİ)</div>
        <div data-code="SEİ">SENDİKA İZNİ (SEİ)</div>
        <div data-code="Üİ">ÜCRETSİZ İZİN (Üİ)</div>
        <div data-code="Kİ">KONGRE İZNİ (Kİ)</div>
        <div data-code="İK">İŞ KAZASI (İK)</div>
        <div data-code="DSİ">DOĞUM SONU İZNİ (DSİ)</div>
        <div data-code="DÖİ">DOĞUM ÖNCESİ İZNİ (DÖİ)</div>
        <div data-code="Nİ">NÖBET İZNİ (Nİ)</div>
        <div data-code="İDİ">İDARİ İZİN (İDİ)</div>
        <div data-code="HY">HASTANEYE YATIŞ (HY)</div>
        <div data-code="HS">HAFTA SONU (HS)</div>
        <div data-code="RT">RESMİ TATİL (RT)</div>
        <div data-code="temizle">[ İzni Temizle ]</div>
    </div>

    <script>
        let holidays = [];
        
        // Tatil günlerini yükle
        async function loadHolidays() {
            try {
                // localStorage'dan yükle (holidays.html'de düzenlenmiş olabilir)
                const savedHolidays = localStorage.getItem('holidays');
                if (savedHolidays) {
                    holidays = JSON.parse(savedHolidays);
                    return true;
                }
                
                // Yoksa JSON dosyasından yüklemeyi dene
                const response = await fetch('holidays.json');
                if (!response.ok) {
                    throw new Error('Tatil günleri yüklenemedi');
                }
                holidays = await response.json();
                
                // İleride kullanmak üzere localStorage'a kaydet
                localStorage.setItem('holidays', JSON.stringify(holidays));
                return true;
            } catch (error) {
                console.error('Tatil günleri yüklenirken hata oluştu:', error);
                // Varsayılan tatiller
                holidays = [
                    { month: 1, day: 1, name: "Yeni Yıl" },
                    { month: 4, day: 23, name: "Ulusal Egemenlik" },
                    { month: 5, day: 1, name: "İşçi Bayramı" },
                    { month: 8, day: 30, name: "Zafer Bayramı" },
                    { month: 10, day: 29, name: "Cumhuriyet Bayramı" }
                ];
                
                // Varsayılan tatilleri localStorage'a kaydet
                localStorage.setItem('holidays', JSON.stringify(holidays));
                return true;
            }
        }
        
        function validateTC(input) {
            let tc = input.value;
            if (tc.length !== 11 || isNaN(tc)) {
                alert("Geçersiz T.C. Kimlik No!");
                input.value = "";
                return;
            }
            let digits = tc.split('').map(Number);
            let check10 = ((digits[0] + digits[2] + digits[4] + digits[6] + digits[8]) * 7 - (digits[1] + digits[3] + digits[5] + digits[7])) % 10;
            let check11 = (digits.slice(0, 10).reduce((a, b) => a + b, 0)) % 10;
            if (digits[9] !== check10 || digits[10] !== check11) {
                alert("Geçersiz T.C. Kimlik No!");
                input.value = "";
            }
        }

        // İzin tipleri
        const leaveTypes = [
            { code: "EV-Eİ", name: "EVLİLİK İZNİ, EĞİTİM İZNİ" },
            { code: "Yİ", name: "YILLIK İZİN" },
            { code: "GÖ", name: "GÖREVLENDİRME" },
            { code: "R", name: "RAPORLU" },
            { code: "Mİ", name: "MAZERET İZNİ" },
            { code: "Öİ", name: "ÖLÜM İZNİ" },
            { code: "Rİ", name: "REFAKAT İZNİ" },
            { code: "SEİ", name: "SENDİKA İZNİ" },
            { code: "Üİ", name: "ÜCRETSİZ İZİN" },
            { code: "Kİ", name: "KONGRE İZNİ" },
            { code: "İK", name: "İŞ KAZASI" },
            { code: "DSİ", name: "DOĞUM SONU İZNİ" },
            { code: "DÖİ", name: "DOĞUM ÖNCESİ İZNİ" },
            { code: "Nİ", name: "NÖBET İZNİ" },
            { code: "İDİ", name: "İDARİ İZİN" },
            { code: "HY", name: "HASTANEYE YATIŞ" },
            { code: "HS", name: "HAFTA SONU" },
            { code: "RT", name: "RESMİ TATİL" }
        ];
        
        // İzin seçim menüsünü göster
        function showLeaveSelect(input) {
            const leaveSelect = document.getElementById('leaveTypeSelect');
            const rect = input.getBoundingClientRect();
            
            leaveSelect.style.top = (rect.bottom + window.scrollY) + 'px';
            leaveSelect.style.left = rect.left + 'px';
            leaveSelect.style.display = 'block';
            
            // İzin tipi seçildiğinde
            leaveSelect.querySelectorAll('div').forEach(div => {
                div.onclick = function() {
                    const code = this.getAttribute('data-code');
                    if (code === 'temizle') {
                        // İzni temizle
                        input.value = '';
                        input.parentElement.classList.remove('leave-type');
                        input.classList.remove('leave-input');
                    } else {
                        // İzin kodunu ata
                        input.value = code;
                        input.parentElement.classList.add('leave-type');
                        input.classList.add('leave-input');
                    }
                    
                    leaveSelect.style.display = 'none';
                    calculateOvertime(input.closest('tr'));
                    trackChanges(); // Değişikliği izle
                };
            });
            
            // Dışarı tıklandığında menüyü kapat
            document.addEventListener('click', closeLeaveSelect);
        }
        
        // İzin seçim menüsünü kapat
        function closeLeaveSelect(event) {
            const leaveSelect = document.getElementById('leaveTypeSelect');
            if (event && event.target.closest('#leaveTypeSelect')) return;
            leaveSelect.style.display = 'none';
            document.removeEventListener('click', closeLeaveSelect);
        }

        function addRow() {
            // Önce takvimi oluştur (eğer henüz oluşturulmadıysa)
            if (document.querySelector('#personelTable thead tr').children.length <= 7) {
                generateCalendar();
            }
            
            // Yeni bir boş satır oluştur
            let table = document.getElementById("personelTable").getElementsByTagName('tbody')[0];
            let newRow = document.createElement('tr');
            
            // Sabit sütunları oluştur
            // TC Kimlik No
            let tcCell = document.createElement('td');
            let tcInput = document.createElement('input');
            tcInput.type = 'text';
            tcInput.className = 'tcNo';
            tcInput.onblur = () => validateTC(tcInput);
            tcCell.appendChild(tcInput);
            newRow.appendChild(tcCell);
            
            // Ad
            let nameCell = document.createElement('td');
            let nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameCell.appendChild(nameInput);
            newRow.appendChild(nameCell);
            
            // Soyad
            let surnameCell = document.createElement('td');
            let surnameInput = document.createElement('input');
            surnameInput.type = 'text';
            surnameCell.appendChild(surnameInput);
            newRow.appendChild(surnameCell);
            
            // Unvan
            let titleCell = document.createElement('td');
            let titleSelect = document.createElement('select');
            let options = ['Tıbbi Sekreter', 'Hemşire', 'Doktor', 'Ebe'];
            options.forEach(option => {
                let optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                titleSelect.appendChild(optionElement);
            });
            titleCell.appendChild(titleSelect);
            newRow.appendChild(titleCell);
            
            // Toplam Çalışma
            let totalWorkCell = document.createElement('td');
            totalWorkCell.className = 'total-work-cell';
            totalWorkCell.textContent = '0';
            newRow.appendChild(totalWorkCell);
            
            // Normal Çalışma
            let normalHoursCell = document.createElement('td');
            normalHoursCell.className = 'normal-hours-cell';
            normalHoursCell.textContent = '0';
            newRow.appendChild(normalHoursCell);
            
            // Fazla Mesai
            let overtimeCell = document.createElement('td');
            overtimeCell.className = 'overtime-cell';
            overtimeCell.textContent = '0';
            newRow.appendChild(overtimeCell);
            
            // Günleri ekle
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = 2025;
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month-1, 1).getDay();
            
            let currentDay = firstDay;
            for(let day=1; day<=daysInMonth; day++) {
                const td = document.createElement('td');
                td.className = 'day-column';
                const input = document.createElement('input');
                input.type = 'text';
                input.min = 0;
                input.max = 24;
                input.value = 0;
                input.className = 'hours day-input';
                input.oninput = () => validateHours(input);
                
                // Çift tıklama ile izin giriş penceresi açma
                input.ondblclick = function(e) {
                    e.preventDefault();
                    showLeaveSelect(this);
                };

                if(currentDay === 0 || currentDay === 6) td.classList.add('weekend');
                if(holidays.some(h => h.month === month && h.day === day)) td.classList.add('holiday');
                
                td.appendChild(input);
                newRow.appendChild(td);
                currentDay = (currentDay + 1) % 7;
            }
            
            // Yeni satırı tabloya ekle
            table.appendChild(newRow);
            
            // Hesaplamaları yap
            calculateOvertime(newRow);
            trackChanges(); // Değişikliği izle
        }

        function calculateOvertime(row) {
            const month = parseInt(document.getElementById('monthSelect').value);
            const inputs = row.querySelectorAll('.hours');
            
            // Toplam çalışma saati
            let totalWorkHours = 0;
            
            inputs.forEach((input, index) => {
                const day = index + 1;
                
                // İzin kontrolü
                const isLeave = input.classList.contains('leave-input');
                
                // Eğer izinde değilse çalışma saatini ekle
                if (!isLeave) {
                    const hours = parseInt(input.value) || 0;
                    totalWorkHours += hours;
                }
            });
            
            // Aylık normal çalışma saatini hesapla
            const normalHours = calculateMonthlyNormalHours(row);
            
            // Fazla mesai saatini hesapla
            const overtimeHours = Math.max(0, totalWorkHours - normalHours);
            
            // Değerleri güncelle
            row.querySelector('.total-work-cell').textContent = totalWorkHours;
            row.querySelector('.normal-hours-cell').textContent = normalHours;
            row.querySelector('.overtime-cell').textContent = overtimeHours;
        }
        
        // Aylık normal çalışma saatini hesaplama
        function calculateMonthlyNormalHours(row) {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = 2025;
            const daysInMonth = new Date(year, month, 0).getDate();
            const inputs = row.querySelectorAll('.hours');
            
            let normalHours = 0;
            
            // Ayın tüm günlerini kontrol et
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month-1, day);
                const dayOfWeek = date.getDay(); // 0=Pazar, 6=Cumartesi
                
                // Sadece hafta içi günleri (1-5) hesapla
                if (dayOfWeek > 0 && dayOfWeek < 6) {
                    // İndeks 0'dan başladığı için day-1
                    const input = inputs[day-1];
                    
                    // Bu günde izin var mı?
                    const isLeave = input && input.classList.contains('leave-input');
                    
                    // İzin yoksa günlük 8 saat ekle
                    if (!isLeave) {
                        normalHours += 8;
                    }
                    // İzin varsa 0 ekle (yani hesaba katma)
                }
            }
            
            return normalHours;
        }

        function validateHours(input) {
            // Sayısal değer kontrolü ve sınırlama
            if (!input.classList.contains('leave-input')) {
                let value = parseInt(input.value) || 0;
                if(value < 0) input.value = 0;
                if(value > 24) input.value = 24;
            }
            calculateOvertime(input.closest('tr'));
            trackChanges(); // Değişikliği izle
        }

        function generateCalendar() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = 2025;
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month-1, 1).getDay();

            // Başlıkları güncelle
            const thead = document.querySelector('#personelTable thead tr');
            while(thead.children.length > 7) thead.removeChild(thead.lastChild);
            for(let i=1; i<=daysInMonth; i++) {
                const th = document.createElement('th');
                th.textContent = i;
                th.className = 'day-column';
                thead.appendChild(th);
            }

            // Hücreleri yeniden oluştur
            document.querySelectorAll('#personelTable tbody tr').forEach(row => {
                // Mevcut mesai değerlerini ve izin kodlarını sakla
                const existingInputValues = [];
                const existingLeaveData = [];
                
                row.querySelectorAll('.hours').forEach(input => {
                    existingInputValues.push(input.value);
                    
                    // İzin bilgisini sakla
                    if (input.classList.contains('leave-input')) {
                        existingLeaveData.push({
                            index: existingInputValues.length - 1,
                            code: input.value
                        });
                    }
                });
                
                // Önce sabit sütunları geçici olarak sakla
                const tcCol = row.children[0].cloneNode(true);
                const nameCol = row.children[1].cloneNode(true);
                const surnameCol = row.children[2].cloneNode(true);
                const titleCol = row.children[3].cloneNode(true);
                const totalWorkCol = row.children[4].cloneNode(true);
                const normalHoursCol = row.children[5].cloneNode(true);
                const overtimeCol = row.children[6].cloneNode(true);
                
                // Tüm sütunları temizle
                while(row.children.length > 0) {
                    row.removeChild(row.children[0]);
                }
                
                // Sabit sütunları geri ekle
                row.appendChild(tcCol);
                row.appendChild(nameCol);
                row.appendChild(surnameCol);
                row.appendChild(titleCol);
                row.appendChild(totalWorkCol);
                row.appendChild(normalHoursCol);
                row.appendChild(overtimeCol);
                
                // Günleri ekle
                let currentDay = firstDay;
                for(let day=1; day<=daysInMonth; day++) {
                    const td = document.createElement('td');
                    td.className = 'day-column';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.min = 0;
                    input.max = 24;
                    
                    // Mevcut değeri koru veya 0 ata
                    if (existingInputValues.length > day-1) {
                        input.value = existingInputValues[day-1];
                    } else {
                        input.value = 0;
                    }
                    
                    input.className = 'hours day-input';
                    input.oninput = () => validateHours(input);
                    
                    // Çift tıklama ile izin giriş penceresi açma
                    input.ondblclick = function(e) {
                        e.preventDefault();
                        showLeaveSelect(this);
                    };

                    if(currentDay === 0 || currentDay === 6) td.classList.add('weekend');
                    if(holidays.some(h => h.month === month && h.day === day)) td.classList.add('holiday');
                    
                    // İzin bilgisini varsa geri yükle
                    const existingLeave = existingLeaveData.find(l => l.index === day-1);
                    if (existingLeave) {
                        input.value = existingLeave.code;
                        input.classList.add('leave-input');
                        td.classList.add('leave-type');
                    }
                    
                    td.appendChild(input);
                    row.appendChild(td);
                    currentDay = (currentDay + 1) % 7;
                }
                
                // TC Kimlik doğrulama olayını yeniden bağla
                const tcInput = row.querySelector('.tcNo');
                if (tcInput) {
                    tcInput.onblur = () => validateTC(tcInput);
                }
                
                // Hesaplamaları yap
                calculateOvertime(row);
            });
        }

        // Form verileri değişti mi (sayfa kapatma kontrolü için)
        let formChanged = false;
        
        // Input değişikliğini izle
        function trackChanges() {
            formChanged = true;
        }
        
        // Sayfa yüklendiğinde değişiklik izlemeyi başlat
        function setupChangeTracking() {
            // Tüm input ve select elementlerini izle
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', trackChanges);
                element.addEventListener('input', trackChanges);
            });
            
            // Ekle ve Tatil Ekle butonlarına tıklanınca değişiklik olarak işaretle
            document.querySelectorAll('button').forEach(button => {
                if (button.innerHTML === 'Ekle' || button.innerHTML === 'Tatil Ekle') {
                    button.addEventListener('click', trackChanges);
                }
            });
            
            // Sayfa kapatıldığında veya yenilendiğinde uyarı göster
            window.addEventListener('beforeunload', function(e) {
                if (formChanged) {
                    // Standart mesaj (tarayıcıya göre değişebilir)
                    const message = 'Formdaki değişiklikler kaydedilmeyecek. Sayfadan ayrılmak istediğinize emin misiniz?';
                    e.returnValue = message;
                    return message;
                }
            });
        }

        // Fazla mesai raporu oluştur
        function generateOvertimeReport() {
            const table = document.getElementById('personelTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            if (rows.length === 0) {
                alert('Personel kaydı bulunamadı!');
                return;
            }
            
            // Aktif ayı al
            const monthSelect = document.getElementById('monthSelect');
            const monthName = monthSelect.options[monthSelect.selectedIndex].text;
            const year = 2025;
            
            // Excel verileri için dizi oluştur
            const excelData = [];
            
            // Başlık satırı
            excelData.push(["TC Kimlik No", "Adı", "Soyadı", "Unvan", "Toplam Çalışma", "Normal Çalışma", "Fazla Mesai"]);
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // Personel bilgilerini al
                const tcNo = row.cells[0].querySelector('input').value;
                const firstName = row.cells[1].querySelector('input').value;
                const lastName = row.cells[2].querySelector('input').value;
                const title = row.cells[3].querySelector('select').value;
                
                // Mesai bilgilerini al
                const totalWork = row.cells[4].textContent;
                const normalHours = row.cells[5].textContent;
                const overtime = row.cells[6].textContent;
                
                // Boş kayıtları kontrol et
                if (!tcNo || !firstName || !lastName) continue;
                
                // Excel satırı ekle
                excelData.push([tcNo, firstName, lastName, title, totalWork, normalHours, overtime]);
            }
            
            // Excel çalışma kitabı oluştur
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(excelData);
            
            // Sütun genişliklerini ayarla
            const columns = [
                { wch: 15 },  // TC Kimlik No
                { wch: 15 },  // Adı
                { wch: 15 },  // Soyadı
                { wch: 15 },  // Unvan
                { wch: 15 },  // Toplam Çalışma
                { wch: 15 },  // Normal Çalışma
                { wch: 15 },  // Fazla Mesai
            ];
            worksheet['!cols'] = columns;
            
            // Çalışma sayfasını çalışma kitabına ekle
            XLSX.utils.book_append_sheet(workbook, worksheet, `${monthName} ${year}`);
            
            // Dosyayı indir
            XLSX.writeFile(workbook, `Fazla_Mesai_Raporu_${monthName}_${year}.xlsx`);
        }

        window.onload = async function() {
            await loadHolidays();
            generateCalendar();
            setupChangeTracking(); // Değişiklik izlemeyi başlat
            formChanged = false; // Başlangıçta değişiklik yok
        };
    </script>
</body>
</html>